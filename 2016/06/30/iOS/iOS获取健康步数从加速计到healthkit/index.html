<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/myIcon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/myIcon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/myIcon.png?v=5.1.3">


  <link rel="mask-icon" href="/images/myIcon.png?v=5.1.3" color="#222">





  <meta name="keywords" content="iOS," />





  <link rel="alternate" href="/atom.xml" title="洛洛爱吃肉" type="application/atom+xml" />






<meta name="description" content="又改需求了,所以又换了全新的统计步数的方法,整理一下吧。 在iPhone5s以前机型因为没有陀螺仪的存在,所以需要用加速度传感器来采集加速度值信息,然后根据震动幅度让其加入踩点数组并过滤,获取自己需要的步数数据。 直接上代码吧: 首先需要一个步数的model如下: 12345678910111213141516#import &amp;lt;Foundation/Foundation.h&amp;gt;@inte">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS获取健康步数从加速计到healthkit">
<meta property="og:url" content="http://yoursite.com/2016/06/30/iOS/iOS获取健康步数从加速计到healthkit/index.html">
<meta property="og:site_name" content="洛洛爱吃肉">
<meta property="og:description" content="又改需求了,所以又换了全新的统计步数的方法,整理一下吧。 在iPhone5s以前机型因为没有陀螺仪的存在,所以需要用加速度传感器来采集加速度值信息,然后根据震动幅度让其加入踩点数组并过滤,获取自己需要的步数数据。 直接上代码吧: 首先需要一个步数的model如下: 12345678910111213141516#import &amp;lt;Foundation/Foundation.h&amp;gt;@inte">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-10-31T10:34:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS获取健康步数从加速计到healthkit">
<meta name="twitter:description" content="又改需求了,所以又换了全新的统计步数的方法,整理一下吧。 在iPhone5s以前机型因为没有陀螺仪的存在,所以需要用加速度传感器来采集加速度值信息,然后根据震动幅度让其加入踩点数组并过滤,获取自己需要的步数数据。 直接上代码吧: 首先需要一个步数的model如下: 12345678910111213141516#import &amp;lt;Foundation/Foundation.h&amp;gt;@inte">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'HYD1K2Q0X8',
      apiKey: 'bc57eb508190643696cd1f13aa415337',
      indexName: 'loirou',
      hits: {"per_page":10},
      labels: {"input_placeholder":"输入关键词进行搜索","hits_empty":"找不到关于\" ${query} \"的文章","hits_stats":"共找到 ${hits} 篇文章,花了 ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/06/30/iOS/iOS获取健康步数从加速计到healthkit/"/>





  <title>iOS获取健康步数从加速计到healthkit | 洛洛爱吃肉</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">洛洛爱吃肉</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/30/iOS/iOS获取健康步数从加速计到healthkit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="loirou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myIcon.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="洛洛爱吃肉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS获取健康步数从加速计到healthkit</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-30T13:43:00+08:00">
                2016-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/06/30/iOS/iOS获取健康步数从加速计到healthkit/" class="leancloud_visitors" data-flag-title="iOS获取健康步数从加速计到healthkit">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>又改需求了,所以又换了全新的统计步数的方法,整理一下吧。</p>
<p>在iPhone5s以前机型因为没有陀螺仪的存在,所以需要用加速度传感器来采集加速度值信息,然后根据震动幅度让其加入踩点数组并过滤,获取自己需要的步数数据。</p>
<p>直接上代码吧:</p>
<p>首先需要一个步数的model如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">VHSSteps</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="comment">//步数模型</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSDate</span> *date;</div><div class="line"></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="keyword">int</span> record_no;</div><div class="line"></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *record_time;</div><div class="line"></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="keyword">int</span> step;</div><div class="line"></div><div class="line"><span class="comment">//g是一个震动幅度的系数,通过一定的判断条件来判断是否计做一步</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="keyword">double</span> g;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>然后是如何获取步数,首先判断传感器是否可用</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//加速度传感器</span></div><div class="line"> <span class="keyword">self</span>.motionManager = [[<span class="built_in">CMMotionManager</span> alloc] init];</div><div class="line"> <span class="comment">// 检查传感器到底在设备上是否可用</span></div><div class="line"> <span class="keyword">if</span> (!<span class="keyword">self</span>.motionManager.accelerometerAvailable) &#123;</div><div class="line">     <span class="keyword">return</span>;</div><div class="line"> &#125; <span class="keyword">else</span> &#123;</div><div class="line">     <span class="comment">// 更新频率是100Hz</span></div><div class="line">     <span class="comment">//以pull方式获取数据</span></div><div class="line">     <span class="keyword">self</span>.motionManager.accelerometerUpdateInterval = <span class="number">1.0</span>/<span class="number">40</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>可用的话开始实现统计步数的算法</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@try</span></div><div class="line">   &#123;</div><div class="line">       <span class="comment">//如果不支持陀螺仪,需要用加速传感器来采集数据</span></div><div class="line">       <span class="keyword">if</span> (!<span class="keyword">self</span>.motionManager.isAccelerometerActive) &#123;<span class="comment">//  isAccelerometerAvailable方法用来查看加速度器的状态：是否Active（启动）。</span></div><div class="line">           </div><div class="line">           <span class="comment">// 加速度传感器采集的原始数组</span></div><div class="line">           <span class="keyword">if</span> (arrAll == <span class="literal">nil</span>) &#123;</div><div class="line">               arrAll = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">               [arrAll removeAllObjects];</div><div class="line">           &#125;</div><div class="line">           </div><div class="line">           <span class="comment">/*</span></div><div class="line"><span class="comment">            1.push方式</span></div><div class="line"><span class="comment">            这种方式，是实时获取到Accelerometer的数据，并且用相应的队列来显示。即主动获取加速计的数据。</span></div><div class="line"><span class="comment">            */</span></div><div class="line">           <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</div><div class="line">           </div><div class="line">           [<span class="keyword">self</span>.motionManager startAccelerometerUpdatesToQueue:queue withHandler:^(<span class="built_in">CMAccelerometerData</span> *accelerometerData, <span class="built_in">NSError</span> *error)&#123;</div><div class="line">               </div><div class="line">               <span class="keyword">if</span> (!<span class="keyword">self</span>.motionManager.isAccelerometerActive) &#123;</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">               </div><div class="line">               <span class="comment">//三个方向加速度值</span></div><div class="line">               <span class="keyword">double</span> x = accelerometerData.acceleration.x;</div><div class="line">               <span class="keyword">double</span> y = accelerometerData.acceleration.y;</div><div class="line">               <span class="keyword">double</span> z = accelerometerData.acceleration.z;</div><div class="line">               <span class="comment">//g是一个double值 ,根据它的大小来判断是否计为1步.</span></div><div class="line">               <span class="keyword">double</span> g = sqrt(pow(x, <span class="number">2</span>) + pow(y, <span class="number">2</span>) + pow(z, <span class="number">2</span>)) - <span class="number">1</span>;</div><div class="line">               </div><div class="line">               <span class="comment">//将信息保存在步数模型中</span></div><div class="line">               VHSSteps *stepsAll = [[VHSSteps alloc] init];</div><div class="line">               </div><div class="line">               stepsAll.date = [<span class="built_in">NSDate</span> date];</div><div class="line">               </div><div class="line">               <span class="comment">//日期</span></div><div class="line">               <span class="built_in">NSDateFormatter</span> *df = [[<span class="built_in">NSDateFormatter</span> alloc] init] ;</div><div class="line">               df.dateFormat  = <span class="string">@"yyyy-MM-dd HH:mm:ss"</span>;</div><div class="line">               <span class="built_in">NSString</span> *strYmd = [df stringFromDate:stepsAll.date];</div><div class="line">               df = <span class="literal">nil</span>;</div><div class="line">               stepsAll.record_time =strYmd;</div><div class="line">               </div><div class="line">               stepsAll.g = g;</div><div class="line">               <span class="comment">// 加速度传感器采集的原始数组</span></div><div class="line">               [arrAll addObject:stepsAll];</div><div class="line">               </div><div class="line">               <span class="comment">// 每采集10条，大约1.2秒的数据时，进行分析</span></div><div class="line">               <span class="keyword">if</span> (arrAll.count == <span class="number">10</span>) &#123;</div><div class="line">                   </div><div class="line">                   <span class="comment">// 步数缓存数组</span></div><div class="line">                   <span class="built_in">NSMutableArray</span> *arrBuffer = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">                   </div><div class="line">                   arrBuffer = [arrAll <span class="keyword">copy</span>];</div><div class="line">                   [arrAll removeAllObjects];</div><div class="line">                   </div><div class="line">                   <span class="comment">// 踩点数组</span></div><div class="line">                   <span class="built_in">NSMutableArray</span> *arrCaiDian = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">                   </div><div class="line">                   <span class="comment">//遍历步数缓存数组</span></div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arrBuffer.count - <span class="number">2</span>; i++) &#123;</div><div class="line">                       <span class="comment">//如果数组个数大于3,继续,否则跳出循环,用连续的三个点,要判断其振幅是否一样,如果一样,然并卵</span></div><div class="line">                       <span class="keyword">if</span> (![arrBuffer objectAtIndex:i<span class="number">-1</span>] || ![arrBuffer objectAtIndex:i] || ![arrBuffer objectAtIndex:i+<span class="number">1</span>])</div><div class="line">                       &#123;</div><div class="line">                           <span class="keyword">continue</span>;</div><div class="line">                       &#125;</div><div class="line">                       VHSSteps *bufferPrevious = (VHSSteps *)[arrBuffer objectAtIndex:i<span class="number">-1</span>];</div><div class="line">                       VHSSteps *bufferCurrent = (VHSSteps *)[arrBuffer objectAtIndex:i];</div><div class="line">                       VHSSteps *bufferNext = (VHSSteps *)[arrBuffer objectAtIndex:i+<span class="number">1</span>];</div><div class="line">                       <span class="comment">//控制震动幅度,,,,,,根据震动幅度让其加入踩点数组,</span></div><div class="line">                       <span class="keyword">if</span> (bufferCurrent.g &lt; <span class="number">-0.12</span> &amp;&amp; bufferCurrent.g &lt; bufferPrevious.g &amp;&amp; bufferCurrent.g &lt; bufferNext.g) &#123;</div><div class="line">                           [arrCaiDian addObject:bufferCurrent];</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   </div><div class="line">                   <span class="comment">//如果没有步数数组,初始化</span></div><div class="line">                   <span class="keyword">if</span> (<span class="literal">nil</span> == <span class="keyword">self</span>.arrSteps) &#123;</div><div class="line">                       <span class="keyword">self</span>.arrSteps = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">                       <span class="keyword">self</span>.arrStepsSave = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">                   &#125;</div><div class="line">                   </div><div class="line">                   <span class="comment">// 踩点过滤</span></div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; arrCaiDian.count; j++) &#123;</div><div class="line">                       VHSSteps *caidianCurrent = (VHSSteps *)[arrCaiDian objectAtIndex:j];</div><div class="line">                       </div><div class="line">                       <span class="comment">//如果之前的步数为0,则重新开始记录</span></div><div class="line">                       <span class="keyword">if</span> (<span class="keyword">self</span>.arrSteps.count == <span class="number">0</span>) &#123;</div><div class="line">                           <span class="comment">//上次记录的时间</span></div><div class="line">                           lastDate = caidianCurrent.date;</div><div class="line">                           </div><div class="line">                           <span class="comment">// 重新开始时，纪录No初始化</span></div><div class="line">                           record_no = <span class="number">1</span>;</div><div class="line">                           record_no_save = <span class="number">1</span>;</div><div class="line">                           </div><div class="line">                           <span class="comment">// 运动识别号</span></div><div class="line">                           <span class="built_in">NSTimeInterval</span> interval = [caidianCurrent.date timeIntervalSince1970];</div><div class="line">                           <span class="built_in">NSNumber</span> *numInter = [[<span class="built_in">NSNumber</span> alloc] initWithDouble:interval*<span class="number">1000</span>];</div><div class="line">                           <span class="keyword">long</span> <span class="keyword">long</span> llInter = numInter.longLongValue;</div><div class="line">                           <span class="comment">//运动识别id</span></div><div class="line">                           <span class="keyword">self</span>.actionId = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%lld"</span>,llInter];</div><div class="line">                           </div><div class="line">                           <span class="keyword">self</span>.distance = <span class="number">0.00</span>f;</div><div class="line">                           <span class="keyword">self</span>.second = <span class="number">0</span>;</div><div class="line">                           <span class="keyword">self</span>.calorie = <span class="number">0</span>;</div><div class="line">                           <span class="keyword">self</span>.step = <span class="number">0</span>;</div><div class="line">                           </div><div class="line">                           <span class="keyword">self</span>.gpsDistance = <span class="number">0.00</span>f;</div><div class="line">                           <span class="keyword">self</span>.agoGpsDistance = <span class="number">0.00</span>f;</div><div class="line">                           <span class="keyword">self</span>.agoActionDistance = <span class="number">0.00</span>f;</div><div class="line">                           </div><div class="line">                           caidianCurrent.record_no = record_no;</div><div class="line">                           caidianCurrent.step = <span class="keyword">self</span>.step;</div><div class="line">                           </div><div class="line">                           [<span class="keyword">self</span>.arrSteps addObject:caidianCurrent];</div><div class="line">                           [<span class="keyword">self</span>.arrStepsSave addObject:caidianCurrent];</div><div class="line">                           </div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span> &#123;</div><div class="line">                           </div><div class="line">                           <span class="keyword">int</span> intervalCaidian = [caidianCurrent.date timeIntervalSinceDate:lastDate] * <span class="number">1000</span>;</div><div class="line">                           </div><div class="line">                           <span class="comment">// 步行最大每秒2.5步，跑步最大每秒3.5步，超过此范围，数据有可能丢失</span></div><div class="line">                           <span class="keyword">int</span> min = <span class="number">259</span>;</div><div class="line">                           <span class="keyword">if</span> (intervalCaidian &gt;= min) &#123;</div><div class="line">                               </div><div class="line">                               <span class="keyword">if</span> (<span class="keyword">self</span>.motionManager.isAccelerometerActive) &#123;</div><div class="line">                                   </div><div class="line">                                   <span class="comment">//存一下时间</span></div><div class="line">                                   lastDate = caidianCurrent.date;</div><div class="line">                                   </div><div class="line">                                   <span class="keyword">if</span> (intervalCaidian &gt;= ACCELERO_START_TIME * <span class="number">1000</span>) &#123;<span class="comment">// 计步器开始计步时间（秒)</span></div><div class="line">                                       <span class="keyword">self</span>.startStep = <span class="number">0</span>;</div><div class="line">                                   &#125;</div><div class="line">                                   </div><div class="line">                                   <span class="keyword">if</span> (<span class="keyword">self</span>.startStep &lt; ACCELERO_START_STEP) &#123;<span class="comment">//计步器开始计步步数 (步)</span></div><div class="line">                                       </div><div class="line">                                       <span class="keyword">self</span>.startStep ++;</div><div class="line">                                       <span class="keyword">break</span>;</div><div class="line">                                   &#125;</div><div class="line">                                   <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.startStep == ACCELERO_START_STEP) &#123;</div><div class="line">                                       <span class="keyword">self</span>.startStep ++;</div><div class="line">                                       <span class="comment">// 计步器开始步数</span></div><div class="line">                                       <span class="comment">// 运动步数（总计）</span></div><div class="line">                                       <span class="keyword">self</span>.step = <span class="keyword">self</span>.step + <span class="keyword">self</span>.startStep;</div><div class="line">                                   &#125;</div><div class="line">                                   <span class="keyword">else</span> &#123;</div><div class="line">                                       <span class="keyword">self</span>.step ++;</div><div class="line">                                   &#125;</div><div class="line">                               </div><div class="line">                                   <span class="comment">//步数在这里</span></div><div class="line">                                   <span class="built_in">NSLog</span>(<span class="string">@"步数%d"</span>,<span class="keyword">self</span>.step);</div><div class="line">                                   </div><div class="line">                                   <span class="keyword">int</span> intervalMillSecond = [caidianCurrent.date timeIntervalSinceDate:[[<span class="keyword">self</span>.arrSteps lastObject] date]] * <span class="number">1000</span>;</div><div class="line">                                   <span class="keyword">if</span> (intervalMillSecond &gt;= <span class="number">1000</span>) &#123;</div><div class="line">                                       </div><div class="line">                                       record_no++; </div><div class="line">                                       caidianCurrent.record_no = record_no;             </div><div class="line">                                       caidianCurrent.step = <span class="keyword">self</span>.step;</div><div class="line">                                       [<span class="keyword">self</span>.arrSteps addObject:caidianCurrent];</div><div class="line">                                   &#125;</div><div class="line">                                   </div><div class="line">                                   <span class="comment">// 每隔100步保存一条数据（将来插入DB用）</span></div><div class="line">                                   VHSSteps *arrStepsSaveVHSSteps = (VHSSteps *)[<span class="keyword">self</span>.arrStepsSave lastObject];</div><div class="line">                                   <span class="keyword">int</span> intervalStep = caidianCurrent.step - arrStepsSaveVHSSteps.step;</div><div class="line">                                   </div><div class="line">                                   <span class="comment">// DB_STEP_INTERVAL 数据库存储步数采集间隔（步） 100步</span></div><div class="line">                                   <span class="keyword">if</span> (<span class="keyword">self</span>.arrStepsSave.count == <span class="number">1</span> || intervalStep &gt;= DB_STEP_INTERVAL) &#123;</div><div class="line">                                       <span class="comment">//保存次数</span></div><div class="line">                                       record_no_save++;</div><div class="line">                                       caidianCurrent.record_no = record_no_save;</div><div class="line">                                       [<span class="keyword">self</span>.arrStepsSave addObject:caidianCurrent];                                      </div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;];</div><div class="line">           </div><div class="line">       &#125;</div><div class="line">   &#125;<span class="keyword">@catch</span> (<span class="built_in">NSException</span> * e) &#123;</div><div class="line">       <span class="built_in">NSLog</span>(<span class="string">@"Exception: %@"</span>, e);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>然后iPhone 5s出现了， 增加了 M7 运动协处理器,也带来了CMStepCounter类,从此我们就不用自己计算步数了,只要直接读取就好。</p>
<p>　　首先还是要检测协处理器是否可用</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!([<span class="built_in">CMStepCounter</span> isStepCountingAvailable] || [<span class="built_in">CMMotionActivityManager</span> isActivityAvailable])) &#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *msg = <span class="string">@"demo只支持iPhone5s以上机型."</span>;</div><div class="line">        <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@"Opps!"</span></div><div class="line">                                                        message:msg</div><div class="line">                                                       delegate:<span class="literal">nil</span></div><div class="line">                                              cancelButtonTitle:<span class="string">@"OK"</span></div><div class="line">                                              otherButtonTitles:<span class="literal">nil</span>];</div><div class="line">        [alert show];</div><div class="line">        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后才是获取步数的方法,主要有两种:</p>
<p>计步 第一种方法</p>
<pre><code>startStepCountingUpdatesToQueue:updateOn:withHandler:

开始分发当前步数计数数据到第三方应用

- (void)startStepCountingUpdatesToQueue:(NSOperationQueue *)queue updateOn:(NSInteger)stepCounts withHandler:(CMStepUpdateHandler)handler
Parameters

queue

被指定执行特定的handler块的操作队列。第三方可以指定一个定制队列或者使用操作队列协助app的主线程。该参数不能为nil

stepCounts

记录的步伐数据，达到该数值去执行handler块。该数值必须大于0

handler

该块在步伐计数达到或超出数值时会被执行，该参数不能为nil。更多块方法信息参考CMStepQueryHandler。

Discussion

该方法实现对用户步伐数据的追踪，并周期性地唤起块方法去分发结果。当第三方调用了该方法，步伐计数器会重置当前步伐数为0，并开始计数。每次计数到达指定的步伐数时，会执行指定的handler块方法。比如，当设定stepCounts为100时，会在100，200，300等数目时发送更新，激活该块方法。每次发送到该块方法的步伐数目都是从你调用该方法开始的步伐数目总和。

每次超过设定步数值时，指定的处理程序块handler会被执行。如果当超过设定值时第三方应用处在被挂起的状态，那程序块也不会被执行。当第三方应用被唤醒，程序块也不会执行，直到再次超过设定步数值。

可以调用stopStepCountingUpdates方法去停止分发步数计数，当然当步数计数对像被销毁的时候，分发过程也会被停止。
</code></pre><p>代码如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([<span class="built_in">CMStepCounter</span> isStepCountingAvailable]) &#123;</div><div class="line">    <span class="keyword">self</span>.stepCounter = [[<span class="built_in">CMStepCounter</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span>.stepCounter startStepCountingUpdatesToQueue:<span class="keyword">self</span>.operationQueue</div><div class="line">                                             updateOn:<span class="number">1</span></div><div class="line">                                          withHandler:</div><div class="line">     ^(<span class="built_in">NSInteger</span> numberOfSteps, <span class="built_in">NSDate</span> *timestamp, <span class="built_in">NSError</span> *error) &#123;</div><div class="line"></div><div class="line">         <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line"></div><div class="line">             <span class="keyword">if</span> (error) &#123;</div><div class="line">                 <span class="built_in">UIAlertView</span> *error = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@"Opps!"</span> message:<span class="string">@"error"</span> delegate:<span class="keyword">self</span> cancelButtonTitle:<span class="string">@"OK"</span> otherButtonTitles:<span class="literal">nil</span>, <span class="literal">nil</span>];</div><div class="line">                 [error show];</div><div class="line">             &#125;</div><div class="line">             <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                 <span class="built_in">NSString</span> *text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"当前步数: %ld"</span>, (<span class="keyword">long</span>)numberOfSteps];</div><div class="line">                 <span class="comment">//这里是步数</span></div><div class="line">                 weakSelf.stepsLabel.text = text;</div><div class="line">             &#125;</div><div class="line">         &#125;);</div><div class="line">     &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>计步 第二种方法</p>
<pre><code>queryStepCountStartingFrom:to:toQueue:withHandler:
 收集并返回某一时间段内的历史步数数据

 - (void)queryStepCountStartingFrom:(NSDate *)start to:(NSDate *)end toQueue:(NSOperationQueue *)queuewithHandler:(CMStepQueryHandler)handler
 Parameters

 start

 收集步数数据的开始时间，该参数不能为 nil.

 end

 收集步数数据的停止时间，该参数不能为nil.

 queue

 执行指定handler块的操作队列，第三方可以指定一个定制队列或者使用操作队列协助app的主线程。该参数不能为nil

 handler

 执行处理结果的块方法，该参数不能为nil。更多块方法信息参考CMStepQueryHandler。

 Discussion

 该方法为异步方法，会立即返回并且把结果分发到指定的handler块中处理。系统最多仅存储最近7天内的有效步数数据。如果在指定时间范围内没有数据，则会传递一个0值到handler块中。
</code></pre><p>　　<br>代码如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取今日步数 </span></div><div class="line"> __<span class="keyword">weak</span> ViewController *weakSelf = <span class="keyword">self</span>;</div><div class="line"><span class="keyword">self</span>.operationQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</div><div class="line"></div><div class="line"><span class="built_in">NSCalendar</span> *calendar = [<span class="built_in">NSCalendar</span> currentCalendar];</div><div class="line"><span class="built_in">NSDate</span> *now = [<span class="built_in">NSDate</span> date];</div><div class="line"><span class="built_in">NSDateComponents</span> *components = [calendar components:<span class="built_in">NSCalendarUnitYear</span>|<span class="built_in">NSCalendarUnitMonth</span>|<span class="built_in">NSCalendarUnitDay</span> fromDate:now];</div><div class="line"><span class="comment">// 开始日期</span></div><div class="line"><span class="built_in">NSDate</span> *startDate = [calendar dateFromComponents:components];</div><div class="line"><span class="comment">// 结束日期</span></div><div class="line"><span class="built_in">NSDate</span> *endDate = [calendar dateByAddingUnit:<span class="built_in">NSCalendarUnitDay</span> value:<span class="number">1</span> toDate:startDate options:<span class="number">0</span>];</div><div class="line"></div><div class="line">  <span class="keyword">if</span> ([<span class="built_in">CMStepCounter</span> isStepCountingAvailable]) &#123;</div><div class="line">    [<span class="keyword">self</span>.stepCounter  queryStepCountStartingFrom:startDate to:endDate toQueue:<span class="keyword">self</span>.operationQueue withHandler:^(<span class="built_in">NSInteger</span> numberOfSteps, <span class="built_in">NSError</span> * _Nullable error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%ld"</span>,numberOfSteps);</div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="keyword">if</span> (error) &#123;</div><div class="line">                <span class="built_in">UIAlertView</span> *error = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@"Opps!"</span> message:<span class="string">@"error"</span> delegate:<span class="keyword">self</span> cancelButtonTitle:<span class="string">@"OK"</span> otherButtonTitles:<span class="literal">nil</span>, <span class="literal">nil</span>];</div><div class="line">                [error show];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                weakSelf.totalLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"今日总步数%ld"</span>,numberOfSteps];</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外,iOS7还增加了CMMotionActivity类,用来获取运动状态</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([<span class="built_in">CMMotionActivityManager</span> isActivityAvailable]) &#123;</div><div class="line">    <span class="keyword">self</span>.activityManager = [[<span class="built_in">CMMotionActivityManager</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span>.activityManager startActivityUpdatesToQueue:<span class="keyword">self</span>.operationQueue</div><div class="line">                                          withHandler:</div><div class="line">     ^(<span class="built_in">CMMotionActivity</span> *activity) &#123;</div><div class="line"></div><div class="line">         <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line"></div><div class="line">             <span class="built_in">NSString</span> *status = [weakSelf statusForActivity:activity];</div><div class="line">             <span class="built_in">NSString</span> *confidence = [weakSelf stringFromConfidence:activity.confidence];</div><div class="line"></div><div class="line">             weakSelf.statusLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"状态: %@"</span>, status];</div><div class="line">             weakSelf.confidenceLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"速度: %@"</span>, confidence];</div><div class="line">         &#125;);</div><div class="line">     &#125;];</div><div class="line">&#125;</div><div class="line">- (<span class="built_in">NSString</span> *)statusForActivity:(<span class="built_in">CMMotionActivity</span> *)activity &#123;</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableString</span> *status = <span class="string">@""</span>.mutableCopy;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (activity.stationary) &#123;</div><div class="line">        </div><div class="line">        [status appendString:<span class="string">@"not moving"</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (activity.walking) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (status.length) [status appendString:<span class="string">@", "</span>];</div><div class="line">        </div><div class="line">        [status appendString:<span class="string">@"on a walking person"</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (activity.running) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (status.length) [status appendString:<span class="string">@", "</span>];</div><div class="line">        </div><div class="line">        [status appendString:<span class="string">@"on a running person"</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (activity.automotive) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (status.length) [status appendString:<span class="string">@", "</span>];</div><div class="line">        </div><div class="line">        [status appendString:<span class="string">@"in a vehicle"</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (activity.unknown || !status.length) &#123;</div><div class="line">        </div><div class="line">        [status appendString:<span class="string">@"unknown"</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> status;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)stringFromConfidence:(<span class="built_in">CMMotionActivityConfidence</span>)confidence &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">switch</span> (confidence) &#123;</div><div class="line">            </div><div class="line">        <span class="keyword">case</span> <span class="built_in">CMMotionActivityConfidenceLow</span>:</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="string">@"Low"</span>;</div><div class="line">            </div><div class="line">        <span class="keyword">case</span> <span class="built_in">CMMotionActivityConfidenceMedium</span>:</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="string">@"Medium"</span>;</div><div class="line">            </div><div class="line">        <span class="keyword">case</span> <span class="built_in">CMMotionActivityConfidenceHigh</span>:</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="string">@"High"</span>;</div><div class="line">            </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好吧,随着时间的推移,iOS8来了,也带来了healthkit,不过之前的方法满足需求也就还是用的CMStepCounter方法。</p>
<p>不过最近客户改需求了,手环,iWatch的数据也需要统计进来,就不得不用healthkit的方法了。</p>
<p><a href="http://www.cocoachina.com/ios/20140915/9624.html" target="_blank" rel="external">healthkit知识普及点这里
</a></p>
<p> 还是老套路,先检查能不能用</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> 　　<span class="comment">//查看healthKit在设备上是否可用，ipad不支持HealthKit</span></div><div class="line"><span class="selector-tag">if</span>(![HKHealthStore isHealthDataAvailable])</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"设备不支持healthKit"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后获取步数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建healthStore实例对象</span></div><div class="line">    self.healthStore = [[HKHealthStore alloc] init];</div><div class="line">    </div><div class="line">    <span class="comment">//设置需要获取的权限这里仅设置了步数</span></div><div class="line">    HKObjectType *stepCount = [HKObjectType <span class="string">quantityTypeForIdentifier:</span>HKQuantityTypeIdentifierStepCount];    </div><div class="line">    NSSet *healthSet = [NSSet <span class="string">setWithObjects:</span>stepCount, nil];</div><div class="line">    </div><div class="line">    <span class="comment">//从健康应用中获取权限</span></div><div class="line">    [self.healthStore <span class="string">requestAuthorizationToShareTypes:</span>nil <span class="string">readTypes:</span>healthSet <span class="string">completion:</span>^(BOOL success, NSError * _Nullable error) &#123;</div><div class="line">        <span class="keyword">if</span> (success)</div><div class="line">        &#123;</div><div class="line">            NSDateFormatter *formatter = [[NSDateFormatter alloc ]init];</div><div class="line">            [formatter <span class="string">setDateFormat:</span>@<span class="string">"yyyy-MM-dd"</span>];</div><div class="line">            NSDate *now = [NSDate date];</div><div class="line">            NSString *todaystr = [formatter <span class="string">stringFromDate:</span>now];</div><div class="line">            NSDate *today = [formatter <span class="string">dateFromString:</span>todaystr];</div><div class="line">            </div><div class="line">            NSDate *next = [today <span class="string">dateByAddingTimeInterval:</span><span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>];</div><div class="line">　　　　　　　<span class="comment">//定义需要获取的数据为步数</span></div><div class="line">            HKQuantityType *quantityType = [HKQuantityType <span class="string">quantityTypeForIdentifier:</span>HKQuantityTypeIdentifierStepCount];</div><div class="line">　　　　　　　<span class="comment">//设置获取的步数时间间隔</span></div><div class="line">　　　　　　　NSDateComponents *dateComponents = [[NSDateComponents alloc] init];</div><div class="line">            dateComponents.day = <span class="number">1</span>;</div><div class="line">            </div><div class="line">            NSPredicate *predicate = [HKQuery <span class="string">predicateForSamplesWithStartDate:</span>today <span class="string">endDate:</span>next <span class="string">options:</span>HKQueryOptionStrictStartDate];</div><div class="line">            <span class="comment">//创建查询统计对象collectionQuery</span></div><div class="line">　　　　　　　HKStatisticsCollectionQuery *collectionQuery = [[HKStatisticsCollectionQuery alloc] <span class="string">initWithQuantityType:</span>quantityType <span class="string">quantitySamplePredicate:</span>predicate <span class="string">options:</span> HKStatisticsOptionCumulativeSum | HKStatisticsOptionSeparateBySource <span class="string">anchorDate:</span>[NSDate <span class="string">dateWithTimeIntervalSince1970:</span><span class="number">0</span>] <span class="string">intervalComponents:</span>dateComponents];</div><div class="line">            collectionQuery.initialResultsHandler = ^(HKStatisticsCollectionQuery *query, HKStatisticsCollection * __nullable result, NSError * __nullable error) &#123;</div><div class="line">                <span class="keyword">float</span> numberOfSteps = <span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span> (HKStatistics *statistic <span class="keyword">in</span> result.statistics) &#123;</div><div class="line">                    </div><div class="line">                    <span class="keyword">for</span> (HKSource *source <span class="keyword">in</span> statistic.sources) &#123;</div><div class="line">                         <span class="comment">//HKSource对象中的name可用于区分健康数据来源</span></div><div class="line">                        <span class="keyword">if</span> ([source.name <span class="string">isEqualToString:</span>deviceName]) &#123;</div><div class="line">                            <span class="keyword">float</span> steps = [[statistic <span class="string">sumQuantityForSource:</span>source] <span class="string">doubleValueForUnit:</span>[HKUnit countUnit]];</div><div class="line">                            numberOfSteps += steps;</div><div class="line">                            </div><div class="line">                        &#125;</div><div class="line">　　　　　　　　　　　　　　  <span class="comment">//deviceName是根据接入的设备做的标记,</span></div><div class="line">                        <span class="keyword">if</span> ([deviceName <span class="string">isEqualToString:</span>@<span class="string">"iPhone"</span>]) &#123;</div><div class="line">                            <span class="keyword">if</span> ([source.name <span class="string">isEqualToString:</span>[UIDevice currentDevice].name]) &#123;</div><div class="line">                                <span class="keyword">float</span> steps = [[statistic <span class="string">sumQuantityForSource:</span>source] <span class="string">doubleValueForUnit:</span>[HKUnit countUnit]];</div><div class="line">                                numberOfSteps += steps;</div><div class="line">                                </div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span> ([deviceName <span class="string">isEqualToString:</span>@<span class="string">"iWatch"</span>] &amp;&amp; ![source.name <span class="string">isEqualToString:</span>[UIDevice currentDevice].name])&#123;</div><div class="line">                            <span class="keyword">if</span> ([source.bundleIdentifier <span class="string">hasPrefix:</span>@<span class="string">"com.apple.health"</span>]) &#123;</div><div class="line">                                <span class="keyword">float</span> steps = [[statistic <span class="string">sumQuantityForSource:</span>source] <span class="string">doubleValueForUnit:</span>[HKUnit countUnit]];</div><div class="line">                                numberOfSteps += steps;</div><div class="line">                                </div><div class="line">                            &#125;</div><div class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span> ([deviceName <span class="string">isEqualToString:</span>@<span class="string">"xiaomi"</span>])&#123;</div><div class="line">                            <span class="keyword">if</span> ([source.name <span class="string">isEqualToString:</span>@<span class="string">"小米运动"</span>] || [source.bundleIdentifier <span class="string">isEqualToString:</span>@<span class="string">"HM.wristband"</span>]) &#123;</div><div class="line">                                <span class="keyword">float</span> steps = [[statistic <span class="string">sumQuantityForSource:</span>source] <span class="string">doubleValueForUnit:</span>[HKUnit countUnit]];</div><div class="line">                                numberOfSteps += steps;</div><div class="line">                                </div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                   </div><div class="line">                &#125;</div><div class="line">                NSLog(@<span class="string">"ff = %f"</span>,numberOfSteps);</div><div class="line">                stepString = [NSString <span class="string">stringWithFormat:</span>@<span class="string">"%.0f"</span>,numberOfSteps];</div><div class="line">            &#125;;</div><div class="line">            [self.healthStore <span class="string">executeQuery:</span>collectionQuery];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            NSLog(@<span class="string">"获取步数权限失败"</span>);</div><div class="line">        &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>demo完整代码在这里:</p>
<p><a href="https://github.com/loirou/WalkStep" target="_blank" rel="external">加速度传感器进行计步</a></p>
<p><a href="https://github.com/loirou/HealthStep" target="_blank" rel="external">CMStepCounter获取健康步数
</a></p>
<p><a href="https://github.com/loirou/healthKitDemo" target="_blank" rel="external">healthkit获取步数
</a></p>

      
    </div>
    
    
    

<div>
      
        
      
</div>

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/05/20/iOS/使用CocoaPods遇到的几个坑,记录一下/" rel="next" title="使用CocoaPods遇到的几个坑,记录一下">
                <i class="fa fa-chevron-left"></i> 使用CocoaPods遇到的几个坑,记录一下
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/15/iOS/解决UISlider滑块不灵敏/" rel="prev" title="解决UISlider滑块不灵敏">
                解决UISlider滑块不灵敏 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMTUzOS84MTAz"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/myIcon.png"
                alt="loirou" />
            
              <p class="site-author-name" itemprop="name">loirou</p>
              <p class="site-description motion-element" itemprop="description">学海无涯,进一步有进一步的欢喜.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/loirou" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">loirou</span>

  
</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.3"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("H1dTuun8VxmsjT227Ei2mpWW-gzGzoHsz", "mGURbecfAmYLFQFpSC79Nbrq");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
  

  

  

  

</body>
</html>
